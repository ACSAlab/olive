#===============================================================================
# Project Makefile 
#
#
# Author: Yichao Cheng (onesuperclark@gmail.com)
# Created on: 2014-10-28
# Last Modified: 2014-10-28
#
#===============================================================================


#-------------------------------------------------------------------------------
# Directories
#-------------------------------------------------------------------------------
PROJECT_ROOT = ../..


#-------------------------------------------------------------------------------
# Compliers and flags
#-------------------------------------------------------------------------------
NVCC = "$(shell which nvcc)"
CXX = g++
NVCCFLAGS = -O3 -g
CFLAGS = -Wall -O3 -g
LDFLAGS = 


#-------------------------------------------------------------------------------
# CUDA Capability 2.0 or 3.5
#-------------------------------------------------------------------------------
GEN_SM20 = -gencode=arch=compute_20,code=\"sm_20,compute_20\"
GEN_SM35 = -gencode=arch=compute_35,code=\"sm_35,compute_35\"

ifneq ($(force_sm_35), 1)
	NVCCFLAGS += $(GEN_SM20)
else
	NVCCFLAGS += $(GEN_SM35)
endif


#-------------------------------------------------------------------------------
# Disable L1 cache by "-Xptxas -dlcm=cg" option at compile time can 
# reduce over-fetch (e.g, in the case of scattered memory accesses)
#-------------------------------------------------------------------------------
ifneq ($(disable_l1_cache), 1)
	NVCCFLAGS += 
else
	NVCCFLAGS += -Xptxas -dlcm=cg
endif


#-------------------------------------------------------------------------------
# Dependency lists
#-------------------------------------------------------------------------------
DEPS = $(wildcard $(PROJECT_ROOT)/olive/*.h)


#-------------------------------------------------------------------------------
# 64 or 32 bit
#-------------------------------------------------------------------------------
ifneq ($(force64), 1)
	# Compile with 32-bit device pointers by default
	ARCH_SUFFIX = i386
	ARCH = -m32
else
	ARCH_SUFFIX = x86_64
	ARCH = -m64
endif


#-------------------------------------------------------------------------------
# BFS
#-------------------------------------------------------------------------------
bfs: bin/$(ARCH_SUFFIX)/test_bfs

bin/$(ARCH_SUFFIX)/bfs: test_bfs.cu $(DEPS)
	@mkdir -p bin
	@mkdir -p bin/$(ARCH_SUFFIX)
	$(NVCCFLAGS) $< -o $@


#-------------------------------------------------------------------------------
# Clean
#-------------------------------------------------------------------------------
clean:
	rm -f *.o 


#-------------------------------------------------------------------------------
# Clean executables
#-------------------------------------------------------------------------------
clean-build: 
	rm -rf bin


